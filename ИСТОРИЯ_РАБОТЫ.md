# История работы над проектом SPHUB

## Дата: 7 февраля 2026

---

## ЗАДАЧА 1: Исправление определения типов медиа в tgdlp.py
**Статус:** ✅ Выполнено

### Проблема
Скрипт `tgdlp.py` определял видео как "unknown" вместо "video"

### Решение
Изменен порядок проверки атрибутов сообщения:
- Сначала проверяем `msg.video`
- Потом `msg.document`
- Это позволило правильно определять видео

---

## ЗАДАЧА 2: Настройка nginx для домена sphub.local
**Статус:** ✅ Выполнено

### Действия
1. Создан конфиг `sphub.conf` для nginx
2. Путь изменен с `/root/pppppost` на `/var/www/pppppost`
3. Решена проблема с портом 443 (конфликт с xray) - убит процесс
4. Исправлены права доступа: `chmod 755`, `chown www-data`
5. Nginx успешно запущен

---

## ЗАДАЧА 3: Пропуск опросов при скачивании
**Статус:** ✅ Выполнено

### Решение
Добавлена проверка в `tgdlp.py`:
```python
if msg.poll:
    continue
```

---

## ЗАДАЧА 4: Улучшение дизайна сайта
**Статус:** ✅ Выполнено

### Изменения в index.html
- Градиентный фон (фиолетово-синий)
- Карточки с тенями и скругленными углами
- Hover эффекты
- Улучшенная типографика
- Название изменено на "СЛИВЫ ПРИВАТКИ SPHUB"

---

## ЗАДАЧА 5: Загрузка файлов на FTP
**Статус:** ✅ Выполнено

### Детали
- FTP сервер: ftpupload.net
- Пользователь: if0_41072753
- Пароль: 1dJB8du0FT
- Созданы скрипты: `upload_ftp.ps1`, `upload_winscp.ps1`
- Пользователь загрузил файлы вручную через FileZilla (4.3GB)

---

## ЗАДАЧА 6: Конвертация видео в HLS формат
**Статус:** ✅ Выполнено

### Процесс
1. Создан `convert_all_to_hls.py` - конвертирует ВСЕ видео в HLS
2. Структура:
   - `video_name.m3u8` в папке downloads/
   - Сегменты в подпапке `video_name/`
3. Создан `fix_m3u8.py` - исправляет пути к сегментам в m3u8 файлах
4. Создан `delete_mp4.py` - удаляет оригинальные mp4 (удалено 50 файлов)
5. Вручную исправлены проблемные видео 530 и 531 с перекодированием

---

## ЗАДАЧА 7: Добавление HLS.js для Firefox
**Статус:** ✅ Выполнено

### Изменения в index.html
- Подключена библиотека hls.js
- Модифицирована функция `openModal()` для определения .m3u8 файлов
- Добавлена переменная `currentHls` для управления экземпляром HLS
- Добавлена очистка в `closeModal()`
- Поддержка нативного HLS для Safari

---

## ЗАДАЧА 8: Скачивание и конвертация поста 532
**Статус:** ✅ Выполнено

### Детали
- Пост 532 содержит 7 видео в альбоме
- Пользователь скачал вручную как video1.mp4 - video7.mp4
- Создан `rename_videos.py` для переименования в формат `video_2025-07-22_12-09-10.mp4` - `video_2025-07-22_12-09-16.mp4`
- Все 7 видео конвертированы в HLS
- Все m3u8 файлы исправлены
- Добавлены в `posts.json` с post_id 532 и текстом "старые работы по Лололошке"

---

## ЗАДАЧА 9: Группировка постов с несколькими файлами
**Статус:** ✅ Выполнено

### Проблема
Посты с несколькими видео показывались как отдельные посты

### Решение
1. JSON структура осталась прежней (несколько записей с одинаковым post_id)
2. HTML изменен для группировки постов по post_id
3. Добавлена функция `groupPostsByPostId()`
4. Посты с несколькими файлами показываются в виде сетки (как в Telegram):
   - 2 файла: 2 колонки
   - 3 файла: большой слева + 2 справа
   - 4 файла: 2x2
   - Больше 4: сетка 3 колонки
5. Добавлены серые полосы между видео (gap: 2px)

---

## ЗАДАЧА 10: Оптимизация загрузки страницы
**Статус:** ✅ Выполнено

### Проблема
При загрузке страницы делалось 60+ запросов к серверу (все видео загружали m3u8)

### Решение
- Заменены `<video>` теги на плейсхолдеры с иконкой воспроизведения
- Видео загружается только при клике
- Результат: 3 запроса вместо 60+ при загрузке страницы

---

## ЗАДАЧА 11: Добавление диапазона дат
**Статус:** ✅ Выполнено

### Изменения
Добавлена надпись в шапке сайта:
"Выгрузка с [самая старая дата] по [самая новая дата]"

---

## ЗАДАЧА 12: Добавление поста 531
**Статус:** ✅ Выполнено

### Процесс
1. Пользователь скачал 3 видео в папку `post_531/`
2. Создан `add_post_531.py` - копирует и переименовывает видео
3. Создан `convert_new_videos.py` - конвертирует в HLS
4. Создан `fix_new_m3u8.py` - исправляет пути в m3u8
5. Создан `reconvert_videos.py` - переконвертация с правильными параметрами ffmpeg
6. Создан `update_post_531_text.py` - обновляет текст на "старые работы по сп"
7. Итого: 4 видео в посте 531

---

## СТРУКТУРА ПРОЕКТА

### Основные файлы
- `tgdlp.py` - скрипт для скачивания из Telegram
- `index.html` - веб-интерфейс сайта
- `posts.json` - база данных постов
- `.env` - переменные окружения (API_ID, API_HASH, CHANNEL_ID)
- `session.session` - сессия Telegram

### Вспомогательные скрипты
- `convert_all_to_hls.py` - конвертация всех видео в HLS
- `fix_m3u8.py` - исправление путей в m3u8 файлах
- `delete_mp4.py` - удаление оригинальных mp4
- `rename_videos.py` - переименование видео
- `add_post_531.py` - добавление видео поста 531
- `convert_new_videos.py` - конвертация новых видео
- `fix_new_m3u8.py` - исправление новых m3u8
- `reconvert_videos.py` - переконвертация с правильными параметрами
- `update_post_531_text.py` - обновление текста поста 531
- `remove_duplicates.py` - удаление дубликатов постов

### Структура downloads/
```
downloads/
├── photo_*.jpg                    # Фотографии
├── video_*.m3u8                   # HLS плейлисты
└── video_*/                       # Папки с сегментами видео
    └── segment*.ts                # Сегменты видео
```

---

## ТЕХНОЛОГИИ

### Backend
- Python 3
- Telethon (Telegram API)
- FFmpeg (конвертация видео)

### Frontend
- HTML5
- CSS3 (градиенты, flexbox, grid)
- JavaScript (ES6+)
- HLS.js (воспроизведение HLS)
- Plyr (видеоплеер)

### Server
- Nginx
- Linux (Arch)

---

## КОНФИГУРАЦИЯ

### Telegram API
- API_ID: 28291939
- API_HASH: 1bef5c813ce843a11dc0d1ada823fe37
- CHANNEL_ID: -1002078162658

### FTP
- Сервер: ftpupload.net
- Пользователь: if0_41072753
- Пароль: 1dJB8du0FT

### Пути
- Локальный: `C:\Users\maybe\Desktop\tgdlp`
- Сервер: `/var/www/pppppost`
- Домен: sphub.local

---

## СТАТИСТИКА

### Посты
- Всего постов: ~150+
- Видео: ~60
- Фото: ~70
- Посты с несколькими файлами: 2 (пост 532 - 7 видео, пост 531 - 4 видео)

### Даты
- Самый старый пост: 22 июля 2025
- Самый новый пост: 5 февраля 2026

---

## ВАЖНЫЕ ЗАМЕТКИ

1. **HLS структура**: m3u8 файл в downloads/, сегменты в подпапке с тем же именем
2. **JSON структура**: Несколько записей с одинаковым post_id для постов с несколькими файлами
3. **Кодировка**: Всегда UTF-8 без BOM
4. **Session файл**: Находится в текущей директории, не в /root/pppppost/
5. **Оптимизация**: Видео не загружаются до клика (плейсхолдеры)
6. **FFmpeg параметры**: `-hls_segment_filename` обязателен для правильного создания сегментов

---

## КОМАНДЫ ДЛЯ ПОВТОРЕНИЯ

### Конвертация видео в HLS
```bash
python convert_all_to_hls.py
python fix_m3u8.py
```

### Добавление новых видео
```bash
python add_post_531.py
python convert_new_videos.py
python fix_new_m3u8.py
```

### Загрузка на сервер
```bash
scp -r downloads/ root@poland.host:/var/www/pppppost/
scp index.html posts.json root@poland.host:/var/www/pppppost/
```

### Nginx
```bash
nginx -t                    # Проверка конфига
systemctl restart nginx     # Перезапуск
systemctl status nginx      # Статус
```

---

## ПРОБЛЕМЫ И РЕШЕНИЯ

### Проблема: 403 Forbidden
**Решение**: `chmod 755` на папки, `chown www-data` на файлы

### Проблема: Порт 443 занят
**Решение**: `lsof -i :443`, `kill -9 <PID>`

### Проблема: Видео определяется как unknown
**Решение**: Проверять `msg.video` перед `msg.document`

### Проблема: FFmpeg создает segment%03d.ts
**Решение**: Использовать параметр `-hls_segment_filename`

### Проблема: 60+ запросов при загрузке
**Решение**: Плейсхолдеры вместо `<video>` тегов

---

## КОНЕЦ ИСТОРИИ
Дата завершения: 7 февраля 2026, 22:30
